<!DOCTYPE html>
<html lang="en">

<head>
    <title>smol</title>
    <style type="text/css" media="screen">
        #editor {
            position: absolute;
            top: 0;
            right: 50%;
            bottom: 0;
            left: 0;
        }

        #right {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 50%;
            background-color: #011527;
            padding: 10px;
        }

        #output {
            color: white;
            font-family: monospace;
        }
    </style>
</head>

<body>
    <div id="editor"></div>
    <div id="right">
        <button onclick="run_program(parse())">Run</button>
        <button onclick="init_editor()">Reset</button>
        <pre id="output"></pre>
    </div>
    <script>
        var editor;
        var registers;

        function init_editor() {
            editor = ace.edit("editor");
            editor.setTheme("ace/theme/cobalt");
            editor.session.setMode("ace/mode/assembly_x86");
            registers = {
            'r0': 0, 'r1': 0, 'r2': 0, 'r3': 0,
            'r4': 0, 'r5': 0, 'r6': 0, 'r7': 0,
            'r8': 0, 'r9': 0, 'ra': 0, 'rb': 0,
            'rc': 0, 'rd': 0, 're': 0, 'rf': 0
            }
            document.getElementById('output').innerHTML = JSON.stringify(registers, null, 4);
        }

        function parseLine(line) {

            if (line === '') { return []; }
            if (line.startsWith(';')) { return []; }

            tokens = line.split(' ');
            parsed_line = []

            for (i = 0; i < tokens.length; i++) {
                tokens[i] = tokens[i].trim();
            }

            if (tokens[0].startsWith(':')) {
                parsed_line.push({ type: 'label', name: tokens[0].slice(1) })
                return parsed_line
            }

            tokens[0] = tokens[0].toLowerCase();
            if (tokens[0] == 'mov') {
                return [{ type: 'mov', src: tokens[1], dest: tokens[2] }]
            }

            if (tokens[0] == 'add') {
                return [{ type: 'add', src: tokens[1], dest: tokens[2] }]
            }

            if (tokens[0] == 'jmpnz') {
                return [{ type: 'jmpnz', src: tokens[1], dest: tokens[2].slice(1) }]
            }
        }

        function parse() {
            text = editor.getValue();
            program = []
            for (line of text.split('\n')) {
                program.push(parseLine(line.trim()))
            }
            program = program.filter(el => el.length != 0);
            return program
        }


        function run_program(program) {
            ip = 0;
            while (ip < program.length) {
                instruction = program[ip][0];
                if (instruction.type == 'mov') {
                    if (instruction.src.startsWith('r')) {
                        registers[instruction.dest] = registers[instruction.src];
                    } else {
                        registers[instruction.dest] = parseInt(instruction.src);
                    }
                }

                if (instruction.type == 'add') {
                    if (instruction.src.startsWith('r')) {
                        registers[instruction.dest] += registers[instruction.src];
                    } else {
                        registers[instruction.dest] += parseInt(instruction.src);
                    }
                }

                if (instruction.type == 'jmpnz') {
                    if (registers[instruction.src] != 0) {
                        for (i = 0; i < program.length; i++) {
                            if (program[i][0].type == 'label' && program[i][0].name == instruction.dest) {
                                ip = i - 1;
                                break;
                            }
                        }
                    }
                }
                ip += 1;
            }
            document.getElementById('output').innerHTML = JSON.stringify(registers, null, 4);
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js" type="text/javascript" charset="utf-8"
        onload="init_editor()"></script>
</body>

</html>